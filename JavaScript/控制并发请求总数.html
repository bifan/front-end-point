<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>æ§åˆ¶å¹¶å‘æ€»æ•°</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
  </head>
  <body>
    <script>
      // è¯·æ±‚urls, åŒä¸€æ—¶é—´æœ€å¤šè¯·æ±‚max ä¸ª
      // å…¨éƒ¨èµ„æºè¯·æ±‚å®Œæ¯•, æ‰§è¡Œcallback

      function sendRequst(urls, max, callback) {
        // å¹¶å‘é‡è®¡æ•°å™¨
        let maxCounter = 0;
        // urls index æŒ‡é’ˆ
        let index = 0;
        // ğŸ”¦
        console.log("ğŸ”¦ urls.length:", urls.length);
        let test_fetch_counter = 0;
        function toFetch() {
          const urlsLength = urls.length;
          if (index < urlsLength) {
            // ğŸ”¦
            console.log("ğŸ”¦ fetching: ", urls[index].slice(-9));
            // è¯·æ±‚ â†’ é€’å¢è®¡æ•°
            maxCounter++;
            fetch(urls[index++])
              .then(response => {
                // å“åº” â†’ é€’å‡è®¡æ•° â†’ å¹¶å‘é‡å°äºmax åˆ™å¢åŠ è¯·æ±‚
                maxCounter--;
                // ğŸ”¦
                console.log("ğŸ”¦ fetched");
                if (maxCounter < max) {
                  toFetch();
                }
                return response.blob();
              })
              .then(imgBlob => {
                // save img
                const imgEle = document.createElement("img");
                imgEle.src = window.URL.createObjectURL(imgBlob);
                document.body.appendChild(imgEle);
              });
          } else if (maxCounter === 0) {
            callback();
          }
        }

        // ç¬¬ä¸€æ¬¡å¹¶å‘max ä¸ªè¯·æ±‚
        for (let i = 0; i < max; i++) {
          toFetch();
        }
      }
    </script>
    <script>
      const max = 20;
      const callback = () => {
        // ğŸ”¦
        console.log("ğŸ”¦ All requests done!");
      };
      fetch("https://api.jikan.moe/v3/producer/21/1")
        .then(response => response.json())
        .then(data => data.anime.map(item => item.image_url))
        .then(urls => sendRequst(urls, max, callback));
    </script>
  </body>
</html>
