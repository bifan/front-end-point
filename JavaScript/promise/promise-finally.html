<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>finally, åšä¸€äº›æ“¦PP çš„äº‹æƒ…(å¦‚é‡Šæ”¾å†…å­˜)</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="renderer" content="webkit" />
    <meta name="force-rendering" content="webkit" />
    <style>
      @media (prefers-color-scheme: dark) {
        body {
          background: #333;
          color: #bbb;
        }
      }
    </style>
  </head>
  <body>
    <script src="">
      // finally åˆ†æ â†’ é€æ˜æ€§, ä¸åšä»»ä½•å¤„ç†, åªæ˜¯æŠŠå€¼ä¼ é€’ä¸‹å»
      new Promise(r => {
        setTimeout(() => {
          r(233);
        }, 2000);
      })
        .finally()
        .then(r => console.log(r));
    </script>
    <script src="">
      // finally åˆ†æ â†’ æ²¡æœ‰å‚æ•°
      new Promise(r => {
        setTimeout(() => {
          r(233);
        }, 2000);
      })
        .finally(r => console.log(r)) // undefind, ğŸ˜”æœ¬å°±ä¸æ˜¯è®©ä½ å¤„ç†è¿”å›å€¼çš„é¸­
        .then(r => console.log(r));
    </script>
    <script src="">
      // finally æ¨¡æ‹Ÿ
      Promise.prototype.finally = function (callback) {
        // Promise å‡½æ•°ä¸‰çŠ¶æ€ä¹‹ä¸€, ä½œä¸ºå¯¹è±¡ä½¿ç”¨
        let P = this.constructor;
        // è€ƒè™‘æ²¡æœ‰ä¼ å…¥callback çš„æƒ…å†µ
        callback = typeof callback === "function" ? callback : false;
        // è°ƒç”¨finally æ—¶å¦‚æœä¼ å…¥äº†å‡½æ•°, é‚£ä¹ˆåœ¨Promise çš„ä¸¤ç§ç»“æœä¸­éƒ½è¦æ‰§è¡Œ
        return this.then(
          value => P.resolve(callback()).then(() => value),
          reason =>
            P.resolve(callback()).then(() => {
              throw reason;
            })
        );
      };
    </script>
  </body>
</html>
<!--
  æ¨¡æ‹Ÿ Promise.finally
  https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/109
-->
