<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Deep Clone</title>
  </head>
  <body>
    <script>
      // ä¸å¤åˆ¶ä¸å¯æšä¸¾å±æ€§, ä¸å¤åˆ¶åŸå‹é“¾ä¸­çš„å±æ€§ä½†ä¿ç•™åŸå‹é“¾

      /***************
       * deep clone method1 (ä¸çŸ¥æ·±æµ…åˆ™é€’å½’ - é²è¿…)
       ***************/
      function deepCloneByRecursion(sourceObject) {
        console.log("Current Deep Clone Method is: ", "deepCloneByRecursion");
        /*****
         * ä¾‹å¤–å’Œè¾¹ç•Œçš„å¤„ç† */

        // éé›†åˆæ€§è´¨çš„å±æ€§ä¸éœ€è¦éå†å’Œé€’å½’, ç›´æ¥è¿”å›
        if (typeof sourceObject !== "object") return sourceObject;
        // typeof null çš„è¿”å›å€¼ä¸º"object", ä½†null ä¸æ˜¯é›†åˆ, ç›´æ¥è¿”å›
        // è¦æå‰å¤„ç†, ä¸ç„¶ä¸‹é¢åˆ›å»ºæ–°å¯¹è±¡çš„æ—¶å€™ä¼šå˜æˆ new null.constructor(), ä¼šæŠ¥TypeError é”™è¯¯
        if (sourceObject === null) return null;
        // æ­£åˆ™çš„typeof è¿”å›å€¼æ˜¯"object", æ­£åˆ™ä¸æ˜¯é›†åˆ, ç›´æ¥è¿”å›
        // æ­£åˆ™ç»è¿‡éå†å’Œé€’å½’å ä¸ºä»€ä¹ˆ /r/ å˜æˆäº† /(?:)/
        // new /r/.constructor() ç­‰äº new RegExp() ç­‰äº /(?:)/
        if (sourceObject instanceof RegExp) return sourceObject; // ç»æµ‹è¯•æ­£åˆ™ä¸æ˜¯å¼•ç”¨ç±»å‹, ç›´æ¥è¿”å›å°±å¯
        // æ—¥æœŸä¼šåœ¨ä¸‹é¢çš„new sourceObject.constructor() æ—¶å˜æˆå½“å‰æ—¶é—´, æ‚„æ‚„å‘ç”Ÿçš„å¯æ€•bug, æ‰€ä»¥è¦ç‰¹åˆ«å¤„ç†
        // æ—¥æœŸæ˜¯å¼•ç”¨ç±»å‹, ä¸èƒ½ç›´æ¥è¿”å›
        if (sourceObject instanceof Date) return new Date(sourceObject); // ç”¨new Date() å¥—ä¸€ä¸‹, äº§ç”Ÿæ–°çš„å†…å­˜ç©ºé—´
        // å‡½æ•°
        // å‡½æ•°åœ¨ç¬¬ä¸€ä¸ªif ä¸­è§£å†³äº†
        // Function å’ŒRegExp ä¸€æ ·ä¼¼ä¹ä¸éœ€è¦ç‰¹åˆ«å¤„ç†å°±å¯ä»¥åšåˆ°deep clone
        // å‡½æ•°ä¸­åŒ…å«é—­åŒ…æ—¶, æ¯ä¸€æ¬¡return å‡½æ•°, è¿™ä¸ªå‡½æ•°éƒ½æ˜¯æ–°çš„å¯¹è±¡, æ‰€ä»¥æ²¡é—®é¢˜
        // if (sourceObject instanceof Function) return new Function(sourceObject);

        /*****
         * é›†åˆçš„å¤„ç† */
        // ä¿ç•™åŸå‹é“¾
        const newObject = new sourceObject.constructor();
        // Symbole ç±»å‹
        // for (let key of []) åªä¼šè¿”å›undefined, å°±åƒæ‰§è¡Œäº†ä¸€ä¸ªæ²¡æœ‰return çš„å‡½æ•°ä¸€æ ·, ä¸ä¼šæœ‰å¼‚å¸¸å‡ºç°çš„, ([]/{}/null/undefined, éƒ½æ²¡é—®é¢˜)
        for (let key of Object.getOwnPropertySymbols(sourceObject)) {
          newObject[key] = sourceObject[key];
        }
        // å…¶å®ƒé›†åˆ, éå†/é€’å½’æ›´æ·±ä¸€å±‚
        for (let key in sourceObject) {
          // é»˜è®¤for in ä¼šéå†åŸå‹é“¾ä¸­çš„å¯æšä¸¾å±æ€§, æ¯”å¦‚constructor
          if (sourceObject.hasOwnProperty(key))
            newObject[key] = deepCloneByRecursion(sourceObject[key]);
        }
        return newObject;
      }

      /***************
       * deep clone method2 (ä¸çŸ¥æ·±æµ…åˆ™é€’å½’2 - é˜¿å¾·å‹’)
       ***************/
      function deepCloneByRecursion2(sourceObject) {
        console.log("Current Deep Clone Method is: ", "deepCloneByRecursion2");
        // null, undefined, string, number, boolean/Boolean, Function
        if (sourceObject === null || typeof sourceObject !== "object")
          return sourceObject;
        if (
          // sourceObject.constructor === Function ||
          // sourceObject.constructor === Boolean ||
          sourceObject.constructor === Date ||
          sourceObject.constructor === RegExp ||
          sourceObject.constructor === String ||
          sourceObject.constructor === Number
        )
          return new sourceObject.constructor(sourceObject);

        const newObject = new sourceObject.constructor();
        for (let key of Object.getOwnPropertySymbols(sourceObject)) {
          newObject[key] = sourceObject[key];
        }
        for (let key in sourceObject) {
          if (sourceObject.hasOwnProperty(key))
            newObject[key] = deepCloneByRecursion2(sourceObject[key]);
        }

        return newObject;
      }

      /***************
       * deep clone method3 (é‡äº‹ä¸å®šä½¿ç”¨å±æ€§ä¿®é¥°ç¬¦ - å¤§å¸ˆå…„å’ŒäºŒå¸ˆå…„)
       ***************/
      function deepCloneByDescriptors(sourceObject) {
        console.log("Current Deep Clone Method is: ", "deepCloneByDescriptors");
        return Object.defineProperties(
          new sourceObject.constructor(),
          Object.getOwnPropertyDescriptors(sourceObject)
        ); // è¿™ç§å§¿åŠ¿ä»¤äººç´¢ç„¶æ— å‘³ - åƒ§åƒ§
      }

      /***************
       * deep clone method4
       ***************/
      // https://coderwall.com/p/m24lsq/deep-copy-object-in-javascript
      // æ­¤å‡½æ•°æ— æ³•å¤„ç†Date/RegExp/åŸºç¡€ç±»å‹çš„åŒ…è£…å¯¹è±¡/Symbol, ä¹Ÿæ²¡æœ‰è¿‡æ»¤åŸå‹é“¾ä¸­çš„å±æ€§
      // åªæ˜¯çœ‹åˆ°å…¶ä½¿ç”¨Object.prototype.toString.call æ¥åšåˆ¤æ–­, åˆ†æä¸€ä¸‹, ä½†æ˜¯å¹¶æ²¡æœ‰å‘ç°ä¼˜åŠ¿
      function deepCopy(oldObj) {
        var newObj = oldObj;
        // æ— æ³•é€šè¿‡if çš„æƒ…å†µ: undefind/null/number/string/boolean/NaN/Function/Symbol(1)/
        if (oldObj && typeof oldObj === "object") {
          // Number/String/Boolean/object/array/
          // Object.prototype.toString.call([]), [object Array]
          // Object.prototype.toString.call({}), [object object]
          // Object.prototype.toString.call(new Number(1)), [object Number], å¦‚æœæ—¶è¿™ç§æƒ…å†µå°±ä¼šå‡ºé—®é¢˜å•Š
          newObj =
            Object.prototype.toString.call(oldObj) === "[object Array]"
              ? []
              : {}; // ä¸å¦‚ä½¿ç”¨newObj = new oldObj.constructor(oldObje)
          for (var i in oldObj) {
            newObj[i] = deepCopy(oldObj[i]);
          }
        }

        return newObj;
      }
      function test(oldObj) {
        if (oldObj && typeof oldObj === "object") return true;
        else return false;
      }

      /***************
       * å¾…clone çš„å¯¹è±¡ (åŒ…å«åŸå‹é“¾å±æ€§/ä¸å¯æšä¸¾å±æ€§/å‡½æ•°å±æ€§/æ­£åˆ™å±æ€§/æ—¥æœŸå±æ€§/Symbol å±æ€§/null)
       ***************/
      const isAlive = Symbol("isAlive");
      const animal = {
        eye: 2,
        see: function() {
          console.log("seeing");
        },
        [isAlive]: true
      };
      const Cat = function() {
        this.sound = "mew";
      };
      Cat.prototype = animal;
      Cat.prototype.constructor = Cat;
      const orangeTabby = new Cat();
      orangeTabby.birthday = new Date("2008");
      orangeTabby.name = "æ©˜é£Ÿä¸å–µ";
      orangeTabby.sexuality = "é›„æ€§";
      const levelTwoSymbol = Symbol("level");
      orangeTabby.deepLevelObject = {
        level1: {
          level1Number: new Number(1),
          level1String: new String("hi"),
          level1Boolean: Boolean(1),
          level1AnonymousFunction: new Function("console.log('new Function()')")
        },
        level2: { level: 2, [levelTwoSymbol]: 2 }
      };
      Object.defineProperty(orangeTabby, "sexuality", {
        enumerable: false
      });
      orangeTabby.regex = /r/;
      orangeTabby.empty = null;
      orangeTabby.runFunction = function() {
        return "runing";
      };
      orangeTabby.closureFunction = function() {
        let closureFlag = 1;
        return function(objectKey) {
          console.log(
            objectKey,
            " closureFunction closureFlag: ",
            ++closureFlag
          );
        };
      };
      orangeTabby.arrowFunction = () => {};
      const isFat = Symbol("isFat");
      const isCute = Symbol("isCute");
      orangeTabby[isFat] = true;
      orangeTabby[isCute] = true;

      /***************
       * æµ‹è¯•clone å®Œæ¯•çš„å¯¹è±¡
       ***************/
      // æºå¯¹è±¡ä¸­å«é—­åŒ…çš„å‡½æ•°ç´¯åŠ å˜é‡
      const orangeTabbyClosureFunction = orangeTabby.closureFunction();
      orangeTabbyClosureFunction("orangeTabby");
      orangeTabbyClosureFunction("orangeTabby");
      orangeTabbyClosureFunction("orangeTabby");

      // invoke clone method
      // ğŸšª entrance ğŸšª entrance ğŸšª entrance ğŸšª entrance ğŸšª entrance ğŸšª entrance ğŸšª
      const clonedOrangeTabby = deepCloneByDescriptors(orangeTabby);

      // æµ‹è¯•å«æœ‰é—­åŒ…å‡½æ•°æ˜¯å¦æœ‰ç‹¬ç«‹å†…å­˜
      clonedOrangeTabby.closureFunction()("clonedOrangeTabby");
      // å¤åˆ¶å®Œæ¯•åä¿®æ”¹æºå¯¹è±¡çš„å±æ€§, ä»¥æµ‹è¯•å¤åˆ¶ç»“æœ
      orangeTabby.deepLevelObject.level1.level = 100;
      // orangeTabby.birthday.setFullYear("2001");
      // clonedOrangeTabby.birthday.setFullYear("2008");
      // clonedOrangeTabby.birthday = null;
      orangeTabby.runFunction = null;
      orangeTabby.regex = null;
      // æ¯”è¾ƒæºå¯¹è±¡å’Œå¤åˆ¶çš„å¯¹è±¡
      console.log("orangeTabby", orangeTabby);
      console.log("clonedOrangeTabby", clonedOrangeTabby);
      console.log(
        "orangeTabby PropertyDescriptors",
        Object.getOwnPropertyDescriptors(orangeTabby)
      );
      console.log(
        "clonedOrangeTabby PropertyDescriptors",
        Object.getOwnPropertyDescriptors(clonedOrangeTabby)
      );
    </script>
  </body>
</html>
<!--
/***************
 * æ“ä½œå±æ€§çš„å§¿åŠ¿
 ***************/

// å¿½è§†æšä¸¾ä¿®é¥°ç¬¦, å¿½è§†Symbol ç±»å‹, ä¸åŒ…å«åŸå‹é“¾ä¸­çš„å±æ€§
Object.getOwnPropertyNames(orangeTabby)
  [ "sound", "birthday", "name", "sexuality", "r", "run" ]

// åªæ˜¾ç¤ºSymbol ç±»å‹, ä¸åŒ…å«åŸå‹é“¾ä¸­çš„å±æ€§
Object.getOwnPropertySymbols(orangeTabby)
  [ Symbol(Hi Symbol) ]

// æ‰€æœ‰key, å¿½è§†æšä¸¾ä¿®é¥°ç¬¦, ä¸åŒ…å«åŸå‹é“¾ä¸­çš„å±æ€§
Reflect.ownKeys(orangeTabby)
  [ "sound", "birthday", "name", "sexuality", "r", "run", Symbol(Hi Symbol) ]

// æ‰€æœ‰å±æ€§, ä¸åŒ…å«åŸå‹é“¾ä¸­çš„å±æ€§
Object.getOwnPropertyDescriptors(orangeTabby)
  birthday: Object { writable: true, enumerable: true, configurable: true, â€¦ }
  name: Object { value: "æ©˜é£Ÿä¸å–µ", writable: true, enumerable: true, â€¦ }
  r: Object { writable: true, enumerable: true, configurable: true, â€¦ }
  run: Object { writable: true, enumerable: true, configurable: true, â€¦ }
  sexuality: Object { value: "é›„æ€§", writable: true, enumerable: false, â€¦ }
  sound: Object { value: "mew", writable: true, enumerable: true, â€¦ }
  Symbol(Hi Symbol): Object { value: true, writable: true, enumerable: true, â€¦ }

// å¯æšä¸¾çš„å±æ€§é”®å€¼å¯¹, å¿½è§†Symbol ç±»å‹, ä¸åŒ…å«åŸå‹é“¾ä¸­çš„å±æ€§ (Object.keys(obj) / Object.values(obj))
Object.entries(orangeTabby)
  0: Array [ "sound", "mew" ]
  1: Array [ "birthday", Date Sun Feb 23 2020 13:22:31 GMT+0800 (ä¸­å›½æ ‡å‡†æ—¶é—´) ]
  2: Array [ "name", "æ©˜é£Ÿä¸å–µ" ]
  3: Array [ "r", /r/ ]
  4: Array [ "run", run()

// å½“çŸ¥é“å±æ€§key çš„æ—¶å€™, åˆ¤æ–­å…¶æ˜¯å¦æ¥è‡ªåŸå‹é“¾
orangeTabby.hasOwnProperty(propertyName)

// æ„é€ å™¨ä¸­å’Œå¯¹è±¡ä¸­çš„å±æ€§æ²¡æœ‰ç±»åˆ«ä¸Šçš„åŒºåˆ«, ç±»åˆ«çš„åŒºåˆ†æ˜¯æŒ‡åŸå‹/éåŸå‹
orangeTabby.hasOwnProperty("eye") // false, åŸå‹é“¾ä¸­
orangeTabby.hasOwnProperty("sound") // ture, æ„é€ å™¨ä¸­çš„å±æ€§

// deep clone æ—¶æƒ³è¦åŸå‹é“¾, é‚£ä¹ˆå°±è¦å…ˆç”¨å…¶æ„é€ å™¨åˆ›å»ºä¸€ä¸ªå¯¹è±¡, å†å¾€å¯¹è±¡é‡Œå¡éåŸå‹é“¾ä¸­çš„å±æ€§

-->

<!--
/***************
 * loops
 ***************/

// for(;;){}
// while(){}
// do...while()

// label/break/continue

// for...in, éå†å¯¹è±¡çš„æ‰€æœ‰å¯æšä¸¾çš„å±æ€§(åŒ…æ‹¬åŸå‹é“¾ä¸­çš„å±æ€§), å¿½ç•¥Symbol ç±»å‹
  // for(index in object){} // for in å¾—åˆ°çš„æ˜¯ä¸‹æ ‡æˆ–key

// for...of, éå†å¯è¿­ä»£å¯¹è±¡
  // for(value of object){} // for of å¾—åˆ°çš„æ˜¯å€¼

-->

<!--
/***************
 * æ²¡æœ‰å‚æ•°æ—¶å¯ä»¥çœç•¥æ‹¬å·
 ***************/

new Object()
new Object // æ²¡æœ‰å‚æ•°æ—¶å¯çœç•¥æ‹¬å·, ä½†æ˜¯ä¸æ˜“è¯»

-->

<!--
/***************
 * instanceof vs constructor
 ***************/

// æ‰‹åŠ¨ä¿®æ”¹åŸå‹å, instanceof æŒ‰é¢„æœŸæ­£ç¡®åˆ¤æ–­
function Person () {}
Person.prototype = {}
const jon = new Person()
console.log(jon instanceof Person) //true
console.log(jon.constructor === Person) //false (jon.constructor is Object)

// constructor å¯ä»¥åˆ¤æ–­åŸå§‹æ•°æ®ç±»å‹ (primitive types)
"Hello World".constructor == String //true
"Hello World" instanceof String //false ("" åœ¨è°ƒç”¨String æ–¹æ³•æ—¶æ‰ä¼šè¢«è½¬ä¸ºå¯¹è±¡)

-->

<!--
/***************
 * JavaScript ä»£ç å—æµ‹é€Ÿ
 ***************/

ç¤ºä¾‹, http://jsben.ch/r4ZGL
-->

<!--
/***************
 * arrow function åœ¨deep clone æ—¶ä¸éœ€è¦ç‰¹æ®Šå¤„ç†
 ***************/

arrowFunction = ()=>{}

typeof arrowFunction // "function"
arrowFunction instanceof Function // true
arrowFunction.constructor === Function // true
-->
